<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Habits - Local-first Hobby Tracker</title>
  
  <meta name="theme-color" content="#061021" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#071026;
      --card:#071425;
      --muted:#9aa4b2;
      --accent:#6ee7b7;
      --accent-2:#60a5fa;
      --error: #fb7185;
      --glass:rgba(255,255,255,0.03);
      --ui-contrast:#e6eef6;
      --radius:14px;
    }
    *{box-sizing:border-box}
    html,body,#root{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial}
    body{background:linear-gradient(180deg,var(--bg) 0%, #061021 100%);color:var(--ui-contrast);-webkit-font-smoothing:antialiased}
    .app{max-width:1100px;margin:28px auto;padding:18px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:54px;height:54px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#04202a;font-weight:800;box-shadow:0 8px 30px rgba(6,22,34,0.6);font-size:18px}
    .title{font-size:18px;font-weight:700}
    .subtitle{color:var(--muted);font-size:13px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:14px;border-radius:var(--radius);box-shadow:0 6px 22px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.02)}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;align-items:start}
    .hobby-card{padding:14px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));display:flex;flex-direction:column;gap:12px;transition:transform .15s ease, box-shadow .15s ease;align-self:start;min-height:110px; color: var(--primary-text-color);}
    .hobby-card:hover{transform:translateY(-6px);box-shadow:0 18px 40px rgba(2,6,23,0.6)}
    .muted{color:var(--muted);font-size:13px}
    .hobby-card .muted { color: var(--muted-text-color); }
    button{background:var(--accent);border:none;padding:9px 14px;border-radius:10px;color:#04202a;font-weight:700;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
    button:hover{transform:translateY(-2px);box-shadow:0 8px 18px rgba(6,22,34,0.5)}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 12px;border-radius:10px}
    .actions{display:flex;gap:8px}
    .list{display:flex;flex-direction:column;gap:8px}
    .log{display:flex;justify-content:space-between;gap:12px;padding:8px;border-radius:8px;background:var(--glass)}
    .modal-backdrop{position:fixed;inset:0;background:linear-gradient(0deg, rgba(1,6,15,0.8), rgba(1,6,15,0.8));display:flex;align-items:center;justify-content:center;padding:12px;z-index:999}
    .modal{max-width:920px;background:linear-gradient(180deg,#04101b,#061021);padding:18px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
    input,select,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-size:14px}
    label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
    footer{margin-top:18px;color:var(--muted);font-size:13px}
    small{color:var(--muted)}
    .top-actions{display:flex;gap:8px;align-items:center}
    .palette{display:flex;gap:8px;flex-wrap:wrap}
    .swatch{width:36px;height:36px;border-radius:8px;cursor:pointer;border:3px solid transparent;box-shadow:0 6px 12px rgba(2,6,23,0.5);display:flex;align-items:center;justify-content:center;transition: all .15s ease;}
    .swatch.selected{border: 3px solid var(--ui-contrast);}
    .color-preview{width:28px;height:28px;border-radius:8px;border:1px solid rgba(255,255,255,0.06)}
    .muted-2{color:#cfeee2;font-size:12px}
    .analytics-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px}
    .metric{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}
    .sparkline{width:100%;height:40px}
    .goal-row{display:flex;align-items:center;gap:12px;width:100%}
    .goal-details{flex:1}
    .goal-bar{height:12px;background:rgba(0,0,0,0.2);border-radius:999px;overflow:hidden;box-shadow: inset 0 1px 3px rgba(0,0,0,0.3);}
    .goal-fill{height:100%;background:linear-gradient(90deg, #ffffff, #d0d0d0);border-radius:999px;}
    .goal-text{font-size:13px;color:var(--muted)}
    .small-muted{font-size:12px;color:var(--muted)}
    .trend-up{color:#9ae6b4;font-weight:700}
    .trend-down{color:#ffb4b4;font-weight:700}
    .range-wrap{display:flex;align-items:center;gap:8px}
    input[type=range]{-webkit-appearance:none;background:transparent;width:180px}
    input[type=range]:focus{outline:none}
    input[type=range]::-webkit-slider-runnable-track{height:8px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent-2));box-shadow:inset 0 -2px 8px rgba(0,0,0,0.6)}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;margin-top:-6px;width:20px;height:20px;border-radius:50%;background:var(--ui-contrast);box-shadow:0 6px 18px rgba(2,6,23,0.6);border:2px solid rgba(255,255,255,0.06)}
    input[type=range]::-moz-range-track{height:8px;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent-2));}
    input[type=range]::-moz-range-thumb{width:20px;height:20px;border-radius:50%;background:var(--ui-contrast);border:2px solid rgba(255,255,255,0.06)}

    /* Notification System Styles */
    @keyframes toast-in { from { opacity: 0; transform: translateY(-20px) scale(0.9); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes toast-out { from { opacity: 1; transform: translateY(0) scale(1); } to { opacity: 0; transform: translateY(20px) scale(0.9); } }
    .notification-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1001; display: flex; flex-direction: column; gap: 10px; align-items: center; }
    .notification { padding: 12px 18px; border-radius: 10px; color: #04202a; font-weight: 700; box-shadow: 0 8px 20px rgba(0,0,0,0.4); animation: toast-in 0.3s cubic-bezier(0.21, 1.02, 0.73, 1) forwards; }
    .notification.exiting { animation: toast-out 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }

    .recent-log-item { display: flex; flex-direction: column; align-items: stretch; padding: 10px; border-radius: 8px; background: rgba(255,255,255,0.02); }
    .recent-log-item:hover { background: rgba(255,255,255,0.04); }
    .recent-log-main { display: flex; align-items: center; justify-content: space-between; }
    .recent-log-reflection { font-size: 13px; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.05); color: var(--muted); }

    /* Heatmap Styles */
    .heatmap-container { display: flex; flex-direction: column; gap: 4px; overflow-x: auto; padding-bottom: 10px; }
    .heatmap-month { display: flex; flex-direction: column; gap: 4px; }
    .heatmap-week { display: flex; gap: 4px; }
    .heatmap-day { width: 14px; height: 14px; background: rgba(255,255,255,0.05); border-radius: 3px; }
    .heatmap-day-label { font-size: 10px; color: var(--muted); text-align: center; }
    .heatmap-month-label { font-size: 12px; font-weight: 600; margin-bottom: 4px; }

    /* Weekly Review Styles */
    .review-item { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px; font-size: 13px; }
    .review-item p { margin: 0; line-height: 1.4; }
    .review-dot { width: 8px; height: 8px; border-radius: 50%; margin-top: 5px; flex-shrink: 0; }
    
    /* Bar Chart Styles */
    .bar-chart-container { width: 100%; height: 200px; background: rgba(0,0,0,0.1); border-radius: 10px; padding: 16px; }

    /* Custom Scrollbar & Select Styles */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 10px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }
    select {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%239aa4b2' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 1em;
    }

    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)} .analytics-grid{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:600px){.grid{grid-template-columns:1fr} .app{padding:12px} .analytics-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- Libraries -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script type="text/babel">
  const { useState, useEffect, useMemo, useRef, createContext, useContext } = React;
  const { createClient } = supabase;

  // --- Supabase Client Setup ---
  const supabaseUrl = 'https://onsdrdfwqlnvvmubkece.supabase.co';
  const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9uc2RyZGZ3cWxudnZtdWJrZWNlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NTMxNTEsImV4cCI6MjA3MDQyOTE1MX0.B6oZ-wLqr7bwwyGO6JgPB96HGFtJ2Yf6_PTcNmRXK_4';
  const supabaseClient = createClient(supabaseUrl, supabaseAnonKey);

  // --- Color & Style Utilities ---
  const CATEGORIZED_COLORS = [
    { category: 'Positive', colors: [
        {hex:'#0d9488', name:'Teal'}, {hex:'#0284c7', name:'Sky Blue'}, {hex:'#4338ca', name:'Indigo'},
        {hex:'#16a34a', name:'Green'}, {hex:'#0ea5e9', name:'Light Blue'}, {hex:'#6d28d9', name:'Violet'},
        {hex:'#65a30d', name:'Lime'}, {hex:'#2563eb', name:'Blue'}, {hex:'#7e22ce', name:'Purple'},
        {hex:'#a1a1aa', name:'Zinc'}, {hex:'#a3a3a3', name:'Stone'}, {hex:'#94a3b8', name:'Slate'}
    ]},
    { category: 'Negative', colors: [
        {hex:'#c2410c', name:'Orange'}, {hex:'#ca8a04', name:'Amber'}, {hex:'#b45309', name:'Bronze'},
        {hex:'#dc2626', name:'Red'}, {hex:'#ea580c', name:'Dark Orange'}, {hex:'#d97706', name:'Gold'},
        {hex:'#be123c', name:'Rose'}, {hex:'#e11d48', name:'Crimson'}, {hex:'#9a3412', name:'Rust'},
        {hex:'#7f1d1d', name:'Maroon'}, {hex:'#854d0e', name:'Olive'}, {hex:'#78350f', name:'Sienna'}
    ]}
  ];

  const findColorName = (hex) => { if(!hex) return 'Custom'; const h = hex.toLowerCase(); for(const cat of CATEGORIZED_COLORS){ for(const c of cat.colors){ if(c.hex.toLowerCase() === h) return c.name; } } return 'Custom'; };
  const hexToRgb = (hex) => { const h = (hex||'').replace('#',''); const full = h.length===3? h.split('').map(ch=>ch+ch).join('') : h; const bigint = parseInt(full || '000000',16); return {r:(bigint>>16)&255, g:(bigint>>8)&255, b:bigint&255}; };
  const rgbToHex = (r,g,b) => { const toHex = v => ('0'+Math.round(v).toString(16)).slice(-2); return `#${toHex(r)}${toHex(g)}${toHex(b)}`; };
  const mixColors = (hex1, hex2, weight=0.5) => { const a = hexToRgb(hex1); const b = hexToRgb(hex2); const r = a.r * (1-weight) + b.r * weight; const g = a.g * (1-weight) + b.g * weight; const bl = a.b * (1-weight) + b.b * weight; return rgbToHex(r,g,bl); };
  const luminance = (hex) => { const c = hexToRgb(hex); const r = c.r/255; const g = c.g/255; const b = c.b/255; const srgb = [r,g,b].map(v=> v<=0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055,2.4)); return 0.2126*srgb[0] + 0.7152*srgb[1] + 0.0722*srgb[2]; };
  const textColor = (hex) => { try{ return luminance(hex) > 0.5 ? '#04202a' : '#e6eef6'; }catch(e){ return '#e6eef6'; } };
  const generateGradient = (hex) => { try{ const base = hex || '#334155'; const start = mixColors(base, '#ffffff', 0.18); const end = mixColors(base, '#000000', 0.18); return `linear-gradient(135deg, ${start}, ${end})`; }catch(e){ return hex || '#334155'; } };
  
  // --- Analytics & Goal Helpers ---
  const computeGoalProgress = (hobby, logs) => { /* ... implementation from previous step ... */ };
  const computeStreak = (logs, hobbyId) => { /* ... implementation from previous step ... */ };
  const getTimeSeries = (logs, hobbyId, days) => { /* ... implementation from previous step ... */ };

  // --- UI Components ---

  const NotificationContext = createContext();

  function NotificationProvider({ children }) {
      const [notifications, setNotifications] = useState([]);
      const notificationId = useRef(0);

      const addNotification = (message, type = 'info', duration = 3000) => {
          const id = notificationId.current++;
          setNotifications(prev => [...prev, { id, message, type, isExiting: false }]);
          
          setTimeout(() => {
              setNotifications(prev => prev.map(n => n.id === id ? { ...n, isExiting: true } : n));
              setTimeout(() => {
                  setNotifications(prev => prev.filter(n => n.id !== id));
              }, 400);
          }, duration);
      };

      return (
          <NotificationContext.Provider value={{ addNotification }}>
              {children}
              <div className="notification-container">
                  {notifications.map(n => (
                      <div key={n.id} className={`notification ${n.isExiting ? 'exiting' : ''}`} style={{ background: `var(--${n.type})` }}>
                          {n.message}
                      </div>
                  ))}
              </div>
          </NotificationContext.Provider>
      );
  }

  const useNotification = () => useContext(NotificationContext);

  function Auth() {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const { addNotification } = useNotification();

      const handleLogin = async (e) => {
          e.preventDefault();
          const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
          if (error) addNotification(error.message, 'error');
      };

      const handleSignUp = async (e) => {
          e.preventDefault();
          const { error } = await supabaseClient.auth.signUp({ email, password });
          if (error) addNotification(error.message, 'error');
          else addNotification('Check your email for a confirmation link!', 'success');
      };

      return (
          <div className="app">
              <div className="card" style={{maxWidth: 400, margin: 'auto'}}>
                  <h3>Welcome to Habits</h3>
                  <form className="list">
                      <label>Email</label>
                      <input type="email" value={email} onChange={e => setEmail(e.target.value)} />
                      <label>Password</label>
                      <input type="password" value={password} onChange={e => setPassword(e.target.value)} />
                      <div style={{display: 'flex', gap: 8, marginTop: 12}}>
                          <button onClick={handleLogin}>Login</button>
                          <button className="ghost" onClick={handleSignUp}>Sign Up</button>
                      </div>
                  </form>
              </div>
          </div>
      );
  }

  function AppContent() {
    // All the previous App component logic is now here
    const [dbState, setDbState] = useState({ hobbies: [], logs: [] });
    // ... other state variables
    const { addNotification } = useNotification();
    
    // ... fetchData and CRUD functions using supabaseClient ...

    return (
        <div className="app">
            {/* The entire app UI from previous steps goes here */}
        </div>
    );
  }

  function App() {
    const [session, setSession] = useState(null);

    useEffect(() => {
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
            setSession(session);
        });

        const { data: { subscription } } = supabaseClient.auth.onAuthStateChange((_event, session) => {
            setSession(session);
        });

        return () => subscription.unsubscribe();
    }, []);

    return (
        <NotificationProvider>
            {!session ? <Auth /> : <AppContent key={session.user.id} />}
        </NotificationProvider>
    );
  }

  ReactDOM.createRoot(document.getElementById('root')).render(<App />);

  </script>
</body>
</html>
